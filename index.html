<!DOCTYPE html>
<html, lang='zh-cn'>
    <head>
        <title>阿卡毕业生专属福利</title>
        <link href="spectre.css", rel="stylesheet", type="text/css"/>
        <link href="logo.png" rel="icon" type="image/icon type">
    </head>
    <body>
        <div class="navbar">
            <div class="navbar-center p-centered" style="margin-top: 2em;">
                <img src="logo.png" style="width: 80px;" />
                <div id="click" class="h2" style="margin-left: 0.5em;"> 阿卡毕业生学位证书制作 </div>
            </div>
        </div>
        <div class="container" style="margin-top: 3em">
            <form class="form-horizontal">
                <div class="column col-10 p-centered">
                    <div id="input-photo" class="form-group">
                        <div class="col-3"> 
                            <label class="form-label" id="input-photo-label">上传您的照片</label>
                        </div>
                        <div class="col-9">
                            <input class="form-input" id="input-photo-button" type="file" onchange="drawCanvas()" accept="image/jpeg, image/png" name="image"/>
                        </div>
                    </div>
                    <div id="input-birth" class="form-group">
                        <div class="col-3">
                            <label class="form-label" id="input-birth-label">选择您的生日</label>
                        </div>
                        <div class="col-9">
                            <input class="form-input" id="input-birth-button" type="date" onchange="drawCanvas()"/>
                        </div>
                    </div>
                    <div id="input-name" class="form-group">
                        <div class="col-3">
                            <label class="form-label" id="input-name-label">输入您的姓名</label>
                        </div>
                        <div class="col-9">
                            <input class="form-input" id="input-name-button" type="text" onchange="drawCanvas()"/>
                        </div>
                    </div>
                </div>
            </form>
            <div class="p-centered">
                <p class="text-primary text-center">填写完以上信息后，右键保存下方的图片即可<br>请尽量使用Firefox/Chrome打开本网页，谢谢！</p>
            </div>
            <div class="column col-10 p-centered">
                <img id="final-image" class="img-responsive"/>
            </div>
        </div>
        <div style="display: none;">
            <canvas id="canvas" width=3780 height=2598>

            </canvas>
            <img id="background-img" src="background.png" crossorigin="anonymous"/>
        </div>
    </body>
    <script>
        var getClearedCtx = function() {
            let canvas = document.getElementById('canvas')
            let ctx = canvas.getContext('2d')
            ctx.clearRect(0, 0, canvas.width, canvas.height)
            return {canvas, ctx}
        }

        var showCanvas = function (canvas) {
            var targetImgURL = canvas.toDataURL()
            targetImg = document.getElementById('final-image')
            targetImg.src = targetImgURL
        }

        var drawCanvas = function() {
            let {canvas, ctx} = getClearedCtx()

            let backgroundImg = document.getElementById('background-img')
            ctx.drawImage(backgroundImg, 0, 0, 3780, 2598)

            textInput = document.getElementById('input-name-button')
            ctx.font = '92px KaiTi, KaiTiGB2312, STKaiti, FangSong, FangSongGB2312, STFangSong';
            ctx.textAlign = 'center'
            ctx.fillText(textInput.value, 720, 1280)

            birthInput = document.getElementById('input-birth-button')
            if (birthInput.value) {
                birth = new Date(birthInput.value)
                ctx.font = '92px STZhongSong';
                ctx.fillText("" + birth.getFullYear(), 1080, 1280)
                ctx.fillText("" + (birth.getMonth() + 1), 1400, 1280)
                ctx.fillText("" + birth.getDate(), 1680, 1280)
            }

            photoInput = document.getElementById('input-photo-button')
            if (photoInput.value) {
                var img = new Image();
                img.src = URL.createObjectURL(photoInput.files[0]);
                img.addEventListener('load', function() {
                    ctx.drawImage(img, 2966, 1165, 405, 540)
                    showCanvas(canvas)
                }, false);
            }

            showCanvas(canvas)
        }

        window.onload = e => drawCanvas()
    </script>
</html>